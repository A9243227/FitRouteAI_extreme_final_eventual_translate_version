<!DOCTYPE html> 
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>èŠå¤©ä¸²æµæ¸¬è©¦</title>
  <style>
    body {
      background-color: #fff;
      color: #000;
      font-family: Arial, sans-serif;
    }

    body.dark-mode {
      background-color: #1e1e1e;
      color: #f1f1f3;
    }

    input[type="text"] {
      padding: 5px;
      font-size: 16px;
    }

    body.dark-mode input[type="text"] {
      background-color: #2e2e33;
      color: #f1f1f1;
      border: 1px solid #555;
    }

    #chat-box {
      white-space: pre-wrap;
      border: 1px solid #ccc;
      padding: 10px;
      width: 500px;
      height: 300px;
      overflow-y: scroll;
      font-family: Arial, sans-serif;
      background-color: #f9f9f9;
      color: #000;
    }

    body.dark-mode #chat-box {
      background-color: #2a2a2e;
      color: #f1f1f3;
      border: 1px solid #3a3a3c;
    }
  </style>
</head>
<body>
  <h2>ğŸš´ è‡ªè¡Œè»Šå°ˆå®¶ èŠå¤©ç³»çµ±</h2>
  <div id="chat-box"></div>
  <input type="text" id="user-input" placeholder="è¼¸å…¥ä½ çš„å•é¡Œ..." style="width: 400px;" />
  <button onclick="sendMessage()">é€å‡º</button>

  <script>
    function markdownToHTML(text) {
      return text.replace(/\*\*(.+?)\*\*/g, '<b>$1</b>');
    }

    async function sendMessage() {
      const userInput = document.getElementById('user-input').value.trim();
      if (!userInput) return;

      const chatBox = document.getElementById('chat-box');
      chatBox.innerHTML += `ğŸ‘¤ä½ ï¼š${userInput}\n`;

      const response = await fetch("/chat_stream", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          messages: [
            { role: "system", content: "ä½ æ˜¯ä¸€ä½è‡ªè¡Œè»Šå°ˆå®¶ï¼Œè«‹ä»¥å°ˆå®¶ç”¨æ·ºé¡¯æ˜“æ‡‚çš„æ–¹å¼å›ç­”ï¼Œå›ç­”å­—æ•¸åœ¨100å­—ä»¥å…§ã€‚" },
            { role: "user", content: userInput }
          ]
        }),
      });

      const reader = response.body.getReader();
      const decoder = new TextDecoder("utf-8");
      let done = false;
      let assistantText = "";

      const assistantDiv = document.createElement("div");
      assistantDiv.innerHTML = "ğŸ¤–æ¨¡å‹ï¼š";
      chatBox.appendChild(assistantDiv);

      while (!done) {
        const { value, done: doneReading } = await reader.read();
        done = doneReading;
        if (value) {
          const chunk = decoder.decode(value);
          assistantText += chunk;

          let safeText = assistantText
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;");

          safeText = safeText.replace(/\*\*(.+?)\*\*/g, '<b>$1</b>');
          assistantDiv.innerHTML = "ğŸ¤–æ¨¡å‹ï¼š" + safeText;
          chatBox.scrollTop = chatBox.scrollHeight;
        }
      }

      document.getElementById('user-input').value = "";
    }

    // æ·±è‰²æ¨¡å¼åˆå§‹åŒ–å‡½å¼
    function initTheme() {
      const savedTheme = localStorage.getItem("theme") || "light";
      document.body.classList.toggle("dark-mode", savedTheme === "dark");
    }

    document.addEventListener("DOMContentLoaded", initTheme);
  </script>
</body>
</html>
